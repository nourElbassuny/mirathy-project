<div class="min-h-screen bg-gradient-to-b from-[#f5f3f0] to-[#ede9e4] py-12 px-4 sm:px-6 lg:px-8" dir="rtl">
  <div class="max-w-6xl mx-auto">
    <div class="text-center mb-12 mt-8">
      <h1 class="text-4xl md:text-5xl font-bold text-[#2c3e50] mb-10">
        حاسبة المواريث الإسلامية
      </h1>      
      <div class="flex items-center justify-center gap-4">
          <div class="h-1 w-12 bg-[#c0c0c0] rounded-full"></div>
          <p class="text-lg text-[#2c3e50] font-medium">تحديد حصص الورثة حسب الشريعة الإسلامية</p>
          <div class="h-1 w-12 bg-[#c0c0c0] rounded-full"></div>
        </div>

      <div class="flex items-center justify-center gap-4"></div>
    </div>

  <div class="min-h-[140px] flex items-center justify-center">
    <blockquote *ngIf="verses[currentVerseIndex()] as verse"
      class="relative border-s-4 border-[#B2AC88] ps-8 py-4 bg-white/90 rounded-lg mb-16 max-w-3xl mx-auto w-full transition-opacity duration-500 ease-in-out shadow-md"
      [class.opacity-0]="!isVerseVisible()">
      <div class="absolute top-2 end-2 text-[#5F9598]/40">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M14.017 21v-7.391c0-2.908.942-5.059 2.825-6.425.864-.633 1.958-.949 3.167-.949v3.492c-.933 0-1.654.217-2.167.65-.512.433-.769 1.1-.769 2v8.623h-3.056zm-8 0v-7.391c0-2.908.942-5.059 2.825-6.425.864-.633 1.958-.949 3.167-.949v3.492c-.933 0-1.654.217-2.167.65-.512.433-.769 1.1-.769 2v8.623h-3.056z" />
        </svg>
      </div>
      <p class="italic text-[#2c3e50] text-xl">{{ verse.text }}</p>
      <footer class="text-start mt-2 text-sm text-[#5a5a5a]">- القرآن الكريم، {{ verse.sourceKey }}</footer>
    </blockquote>
  </div>

  <form [formGroup]="form" (ngSubmit)="calculate()" class="space-y-16">

    <div class="bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-lg border border-[#e0dbd4]">
      <h2 class="flex items-center gap-3 text-2xl font-semibold text-[#2c3e50] border-b-2 border-[#c0c0c0] pb-3 mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-[#5a5a5a]" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span>التركة والديون</span>
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <div>
          <label for="deceasedGender" class="block text-sm font-medium text-[#2c3e50] mb-2">جنس المورث</label>
          <select id="deceasedGender" formControlName="deceasedGender"
            class="w-full p-3 bg-white text-[#2c3e50] border border-[#c0c0c0] rounded-lg shadow-sm focus:ring-[#c0c0c0] focus:border-[#c0c0c0]">
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
          </select>
        </div>
        <div>
          <label for="estateAmount" class="block text-sm font-medium text-[#2c3e50] mb-2">قيمة التركة</label>
          <input type="number" id="estateAmount" formControlName="estateAmount"
            (keypress)="onNumericInput($event)"
            class="w-full p-3 bg-white text-[#2c3e50] border border-[#c0c0c0] rounded-lg shadow-sm focus:ring-[#c0c0c0] focus:border-[#c0c0c0]"
            placeholder="أدخل القيمة">
          @if (getEstateError()) {
          <div class="mt-1 text-red-600 text-sm">{{ getEstateError() }}</div>
          }
        </div>
        <div>
          <label for="debts" class="block text-sm font-medium text-[#2c3e50] mb-2">الديون المستحقة</label>
          <input type="number" id="debts" formControlName="debts"
            (keypress)="onNumericInput($event)"
            class="w-full p-3 bg-white text-[#2c3e50] border border-[#c0c0c0] rounded-lg shadow-sm focus:ring-[#c0c0c0] focus:border-[#c0c0c0]"
            placeholder="أدخل قيمة الديون">
          @if (getDebtsError()) {
          <div class="mt-1 text-red-600 text-sm">{{ getDebtsError() }}</div>
          }
        </div>
      </div>
    </div>

    <div class="bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-lg border border-[#e0dbd4]">
      <div class="flex items-center justify-between pb-3 mb-6 border-b-2 border-[#c0c0c0]">
        <h2 class="flex items-center gap-3 text-2xl font-semibold text-[#2c3e50]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-[#5a5a5a]" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span>الوصية</span>
        </h2>
        <button type="button" (click)="form.controls['hasWill'].setValue(!form.controls['hasWill'].value)"
          class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50]"
          [class.bg-[#2c3e50]]="form.controls['hasWill'].value" [class.bg-gray-300]="!form.controls['hasWill'].value">
          <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
            [style.transform]="form.controls['hasWill'].value ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
        </button>
      </div>
      <p class="text-sm text-[#5a5a5a] mb-4">هل يوجد وصية شرعية؟</p>
      <div *ngIf="form.controls['hasWill'].value" formArrayName="wills" class="mt-6 space-y-4">
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg mb-4">
          <p class="text-sm text-blue-800">
            <span class="font-semibold">ملاحظة:</span> الوصية الشرعية لا يمكن أن تتجاوز ثلث الميراث الصافي.
            <span class="font-bold">الحد الأقصى المسموح: {{ getMaxWillAmount() | number:'1.2-2' }}</span>
          </p>
        </div>
        <div *ngFor="let will of wills.controls; let i = index" [formGroupName]="i"
          class="flex flex-col gap-2 p-2 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-3">
            <label class="font-medium text-[#2c3e50] shrink-0">مبلغ الوصية #{{i + 1}}:</label>
            <input type="number" formControlName="amount"
              (keypress)="onNumericInput($event)"
              class="w-full p-2 bg-white text-[#2c3e50] border border-gray-300 rounded-lg shadow-sm focus:ring-[#c0c0c0] focus:border-[#c0c0c0]">
            <button type="button" (click)="removeWill(i)" class="p-2 text-[#AA5656] hover:bg-[#AA5656]/10 rounded-full cursor-pointer">
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
          @if (getWillError(i)) {
          <div class="text-red-600 text-sm pr-2">{{ getWillError(i) }}</div>
          }
        </div>
        <button *ngIf="wills.length < 5" type="button" (click)="addWill()"
          class="w-full flex items-center justify-center gap-2 text-[#2c3e50] border-2 border-dashed border-[#2c3e50] rounded-lg py-3 cursor-pointer hover:bg-[#2c3e50]/5 transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>إضافة وصية</span>
        </button>
      </div>
    </div>

    <div class="bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-lg border border-gray-100">
      <h2 class="flex items-center gap-3 text-2xl font-semibold text-[#2c3e50] border-b-2 border-[#c0c0c0] pb-3 mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.274-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.274.356-1.857m0 0a3.001 3.001 0 015.688 0M17 10a3 3 0 11-6 0 3 3 0 016 0zm-6 2a9 9 0 100-12 9 9 0 000 12z" />
        </svg>
        <span>الورثة</span>
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="heirsSection">

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg space-y-2"
          [class.bg-[#d4af37]/10]="getHeirControl('wife')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('wife')?.value > 0"
          [class.opacity-40]="getHeirControl('wife')?.disabled"
          [class.pointer-events-none]="getHeirControl('wife')?.disabled">
          <div class="flex items-center justify-between">
            <label for="wife-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الزوجة</label>
            <button id="wife-toggle" type="button" (click)="toggleHeir('wife')"
              [disabled]="getHeirControl('wife')?.disabled"
              class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
              [class.bg-[#2c3e50]]="getHeirControl('wife')?.value > 0"
              [class.bg-gray-200]="!(getHeirControl('wife')?.value > 0)">
              <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
                [style.transform]="getHeirControl('wife')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
            </button>
          </div>
          @if(getHeirControl('wife')?.value > 0) {
          <div class="flex items-center justify-end pt-1">
            <div class="flex items-center gap-3">
              <button type="button" (click)="decrementHeir('wife')" [disabled]="getHeirControl('wife')?.value <= 1"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50] disabled:opacity-50 cursor-pointer disabled:cursor-not-allowed hover:bg-gray-300 transition duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <span class="font-bold text-lg text-[#2c3e50] w-8 text-center">{{ getHeirControl('wife')?.value }}</span>
              <button type="button" (click)="incrementHeir('wife')" [disabled]="getHeirControl('wife')?.value >= 4"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50] disabled:opacity-50 cursor-pointer disabled:cursor-not-allowed hover:bg-gray-300 transition duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
          }
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg flex items-center justify-between"
          [class.bg-[#d4af37]/10]="getHeirControl('husband')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('husband')?.value > 0"
          [class.opacity-40]="getHeirControl('husband')?.disabled"
          [class.pointer-events-none]="getHeirControl('husband')?.disabled">
          <label for="husband-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الزوج</label>
          <button id="husband-toggle" type="button" (click)="toggleHeir('husband')"
            [disabled]="getHeirControl('husband')?.disabled"
            class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
            [class.bg-[#2c3e50]]="getHeirControl('husband')?.value > 0"
            [class.bg-gray-200]="!(getHeirControl('husband')?.value > 0)">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
              [style.transform]="getHeirControl('husband')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
          </button>
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg space-y-2"
          [class.bg-[#d4af37]/10]="getHeirControl('son')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('son')?.value > 0"
          [class.opacity-40]="getHeirControl('son')?.disabled"
          [class.pointer-events-none]="getHeirControl('son')?.disabled">
          <div class="flex items-center justify-between">
            <label for="son-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الابن</label>
            <button id="son-toggle" type="button" (click)="toggleHeir('son')"
              [disabled]="getHeirControl('son')?.disabled"
              class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
              [class.bg-[#2c3e50]]="getHeirControl('son')?.value > 0"
              [class.bg-gray-200]="!(getHeirControl('son')?.value > 0)">
              <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
                [style.transform]="getHeirControl('son')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
            </button>
          </div>
          @if(getHeirControl('son')?.value > 0) {
          <div class="flex items-center justify-end pt-1">
            <div class="flex items-center gap-3">
              <button type="button" (click)="decrementHeir('son')" [disabled]="getHeirControl('son')?.value <= 1"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50] disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <span class="font-bold text-lg text-[#2c3e50] w-8 text-center">{{ getHeirControl('son')?.value }}</span>
              <button type="button" (click)="incrementHeir('son')" class="p-1 rounded-full bg-gray-200 text-[#2c3e50]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
          }
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg space-y-2"
          [class.bg-[#d4af37]/10]="getHeirControl('daughter')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('daughter')?.value > 0"
          [class.opacity-40]="getHeirControl('daughter')?.disabled"
          [class.pointer-events-none]="getHeirControl('daughter')?.disabled">
          <div class="flex items-center justify-between">
            <label for="daughter-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">البنت</label>
            <button id="daughter-toggle" type="button" (click)="toggleHeir('daughter')"
              [disabled]="getHeirControl('daughter')?.disabled"
              class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
              [class.bg-[#2c3e50]]="getHeirControl('daughter')?.value > 0"
              [class.bg-gray-200]="!(getHeirControl('daughter')?.value > 0)">
              <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
                [style.transform]="getHeirControl('daughter')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
            </button>
          </div>
          @if(getHeirControl('daughter')?.value > 0) {
          <div class="flex items-center justify-end pt-1">
            <div class="flex items-center gap-3">
              <button type="button" (click)="decrementHeir('daughter')"
                [disabled]="getHeirControl('daughter')?.value <= 1"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50] disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <span class="font-bold text-lg text-[#2c3e50] w-8 text-center">{{ getHeirControl('daughter')?.value
                }}</span>
              <button type="button" (click)="incrementHeir('daughter')"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
          }
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg flex items-center justify-between"
          [class.bg-[#d4af37]/10]="getHeirControl('father')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('father')?.value > 0"
          [class.opacity-40]="getHeirControl('father')?.disabled"
          [class.pointer-events-none]="getHeirControl('father')?.disabled">
          <label for="father-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الأب</label>
          <button id="father-toggle" type="button" (click)="toggleHeir('father')"
            [disabled]="getHeirControl('father')?.disabled"
            class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
            [class.bg-[#2c3e50]]="getHeirControl('father')?.value > 0"
            [class.bg-gray-200]="!(getHeirControl('father')?.value > 0)">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
              [style.transform]="getHeirControl('father')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
          </button>
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg flex items-center justify-between"
          [class.bg-[#d4af37]/10]="getHeirControl('mother')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('mother')?.value > 0"
          [class.opacity-40]="getHeirControl('mother')?.disabled"
          [class.pointer-events-none]="getHeirControl('mother')?.disabled">
          <label for="mother-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الأم</label>
          <button id="mother-toggle" type="button" (click)="toggleHeir('mother')"
            [disabled]="getHeirControl('mother')?.disabled"
            class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
            [class.bg-[#2c3e50]]="getHeirControl('mother')?.value > 0"
            [class.bg-gray-200]="!(getHeirControl('mother')?.value > 0)">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
              [style.transform]="getHeirControl('mother')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
          </button>
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg flex items-center justify-between"
          [class.bg-[#d4af37]/10]="getHeirControl('paternalGrandfather')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('paternalGrandfather')?.value > 0"
          [class.opacity-40]="getHeirControl('paternalGrandfather')?.disabled"
          [class.pointer-events-none]="getHeirControl('paternalGrandfather')?.disabled">
          <label for="paternalGrandfather-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الجد
            لأب</label>
          <button id="paternalGrandfather-toggle" type="button" (click)="toggleHeir('paternalGrandfather')"
            [disabled]="getHeirControl('paternalGrandfather')?.disabled"
            class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
            [class.bg-[#2c3e50]]="getHeirControl('paternalGrandfather')?.value > 0"
            [class.bg-gray-200]="!(getHeirControl('paternalGrandfather')?.value > 0)">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
              [style.transform]="getHeirControl('paternalGrandfather')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
          </button>
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg flex items-center justify-between"
          [class.bg-[#d4af37]/10]="getHeirControl('maternalGrandmother')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('maternalGrandmother')?.value > 0"
          [class.opacity-40]="getHeirControl('maternalGrandmother')?.disabled"
          [class.pointer-events-none]="getHeirControl('maternalGrandmother')?.disabled">
          <label for="maternalGrandmother-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الجدة
            لأم</label>
          <button id="maternalGrandmother-toggle" type="button" (click)="toggleHeir('maternalGrandmother')"
            [disabled]="getHeirControl('maternalGrandmother')?.disabled"
            class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
            [class.bg-[#2c3e50]]="getHeirControl('maternalGrandmother')?.value > 0"
            [class.bg-gray-200]="!(getHeirControl('maternalGrandmother')?.value > 0)">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
              [style.transform]="getHeirControl('maternalGrandmother')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
          </button>
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg flex items-center justify-between"
          [class.bg-[#d4af37]/10]="getHeirControl('paternalGrandmother')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('paternalGrandmother')?.value > 0"
          [class.opacity-40]="getHeirControl('paternalGrandmother')?.disabled"
          [class.pointer-events-none]="getHeirControl('paternalGrandmother')?.disabled">
          <label for="paternalGrandmother-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">الجدة
            لأب</label>
          <button id="paternalGrandmother-toggle" type="button" (click)="toggleHeir('paternalGrandmother')"
            [disabled]="getHeirControl('paternalGrandmother')?.disabled"
            class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
            [class.bg-[#2c3e50]]="getHeirControl('paternalGrandmother')?.value > 0"
            [class.bg-gray-200]="!(getHeirControl('paternalGrandmother')?.value > 0)">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
              [style.transform]="getHeirControl('paternalGrandmother')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
          </button>
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg space-y-2"
          [class.bg-[#d4af37]/10]="getHeirControl('sonOfSon')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('sonOfSon')?.value > 0"
          [class.opacity-40]="getHeirControl('sonOfSon')?.disabled"
          [class.pointer-events-none]="getHeirControl('sonOfSon')?.disabled">
          <div class="flex items-center justify-between">
            <label for="sonOfSon-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">ابن الابن</label>
            <button id="sonOfSon-toggle" type="button" (click)="toggleHeir('sonOfSon')"
              [disabled]="getHeirControl('sonOfSon')?.disabled"
              class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
              [class.bg-[#2c3e50]]="getHeirControl('sonOfSon')?.value > 0"
              [class.bg-gray-200]="!(getHeirControl('sonOfSon')?.value > 0)">
              <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
                [style.transform]="getHeirControl('sonOfSon')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
            </button>
          </div>
          @if(getHeirControl('sonOfSon')?.value > 0) {
          <div class="flex items-center justify-end pt-1">
            <div class="flex items-center gap-3">
              <button type="button" (click)="decrementHeir('sonOfSon')"
                [disabled]="getHeirControl('sonOfSon')?.value <= 1"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50] disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <span class="font-bold text-lg text-[#2c3e50] w-8 text-center">{{ getHeirControl('sonOfSon')?.value
                }}</span>
              <button type="button" (click)="incrementHeir('sonOfSon')"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
          }
        </div>

        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg space-y-2"
          [class.bg-[#d4af37]/10]="getHeirControl('daughterOfSon')?.value > 0"
          [class.ring-[#d4af37]/50]="getHeirControl('daughterOfSon')?.value > 0"
          [class.opacity-40]="getHeirControl('daughterOfSon')?.disabled"
          [class.pointer-events-none]="getHeirControl('daughterOfSon')?.disabled">
          <div class="flex items-center justify-between">
            <label for="daughterOfSon-toggle" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">بنت الابن</label>
            <button id="daughterOfSon-toggle" type="button" (click)="toggleHeir('daughterOfSon')"
              [disabled]="getHeirControl('daughterOfSon')?.disabled"
              class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50"
              [class.bg-[#2c3e50]]="getHeirControl('daughterOfSon')?.value > 0"
              [class.bg-gray-200]="!(getHeirControl('daughterOfSon')?.value > 0)">
              <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
                [style.transform]="getHeirControl('daughterOfSon')?.value > 0 ? (isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)') : 'translateX(0)'"></span>
            </button>
          </div>
          @if(getHeirControl('daughterOfSon')?.value > 0) {
          <div class="flex items-center justify-end pt-1">
            <div class="flex items-center gap-3">
              <button type="button" (click)="decrementHeir('daughterOfSon')"
                [disabled]="getHeirControl('daughterOfSon')?.value <= 1"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50] disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <span class="font-bold text-lg text-[#2c3e50] w-8 text-center">{{ getHeirControl('daughterOfSon')?.value
                }}</span>
              <button type="button" (click)="incrementHeir('daughterOfSon')"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
          }
        </div>

        @for (heir of ['fullBrother', 'fullSister', 'paternalBrother', 'paternalSister',
          'maternalBrother', 'maternalSister']; track heir) {
        @if(getHeirControl(heir)?.value > 0) {
        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg space-y-2" [class.bg-[#d4af37]/10]="true"
          [class.ring-[#d4af37]/50]="true" [class.opacity-40]="getHeirControl(heir)?.disabled"
          [class.pointer-events-none]="getHeirControl(heir)?.disabled">
          <div class="flex items-center justify-between">
            <label [for]="heir+'-toggle'" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">
              @switch (heir) {
              @case ('fullBrother') { أخ شقيق }
              @case ('fullSister') { أخت شقيقة }
              @case ('paternalBrother') { أخ لأب }
              @case ('paternalSister') { أخت لأب }
              @case ('maternalBrother') { أخ لأم }
              @case ('maternalSister') { أخت لأم }
              }
            </label>
            <button [id]="heir+'-toggle'" type="button" (click)="toggleHeir(heir)"
              [disabled]="getHeirControl(heir)?.disabled"
              class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50 bg-[#2c3e50]">
              <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0"
                [style.transform]="isRtl ? 'translateX(-1.75rem)' : 'translateX(1.75rem)'"></span>
          </button>
          </div>
          <div class="flex items-center justify-end pt-1">
            <div class="flex items-center gap-3">
              <button type="button" (click)="decrementHeir(heir)" [disabled]="getHeirControl(heir)?.value <= 1"
                class="p-1 rounded-full bg-gray-200 text-[#2c3e50] disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <span class="font-bold text-lg text-[#2c3e50] w-8 text-center">{{ getHeirControl(heir)?.value }}</span>
              <button type="button" (click)="incrementHeir(heir)" class="p-1 rounded-full bg-gray-200 text-[#2c3e50]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
        } @else {
        <div class="p-3 ring-1 ring-gray-200/80 rounded-lg flex items-center justify-between"
          [class.opacity-40]="getHeirControl(heir)?.disabled"
          [class.pointer-events-none]="getHeirControl(heir)?.disabled">
          <label [for]="heir+'-toggle'" class="font-medium text-[#2c3e50] min-w-0 cursor-pointer">
            @switch (heir) {
            @case ('fullBrother') { أخ شقيق }
            @case ('fullSister') { أخت شقيقة }
            @case ('paternalBrother') { أخ لأب }
            @case ('paternalSister') { أخت لأب }
            @case ('maternalBrother') { أخ لأم }
            @case ('maternalSister') { أخت لأم }
            }
          </label>
          <button [id]="heir+'-toggle'" type="button" (click)="toggleHeir(heir)"
            [disabled]="getHeirControl(heir)?.disabled"
            class="relative inline-flex items-center h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] disabled:cursor-not-allowed disabled:opacity-50 bg-gray-200">
            <span
              class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0 translate-x-0"></span>
          </button>
        </div>
        }
        }
      </div>
    </div>

    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
      <button type="submit" [disabled]="isLoading()"
        class="w-full cursor-pointer sm:w-auto flex items-center justify-center gap-3 bg-[#2c3e50] hover:bg-[#1a1f2e] transition duration-300 text-white font-bold py-4 px-10 rounded-full shadow-lg disabled:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#c0c0c0]">
        @if (isLoading()) {
        <svg class="animate-spin -ms-1 me-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <span>جاري الحساب...</span>
        } @else {
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm-1 4a1 1 0 100 2h6a1 1 0 100-2H6z"
            clip-rule="evenodd" />
        </svg>
        <span>حساب الميراث</span>
        }
      </button>
    </div>
  </form>

  <div class="mt-16" id="resultsSection">
    <div *ngIf="calculationResult() as results">
      <div class="bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-lg border border-gray-100">
        <!-- العنوان وزر إعادة الإدخال في نفس السطر -->
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold text-[#2c3e50]">نتائج حساب الميراث</h2>
          <button type="button" (click)="resetForm()"
            class="flex items-center gap-2 text-[#2c3e50] border border-[#2c3e50] hover:bg-[#2c3e50] hover:text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            إعادة إدخال المسألة
          </button>
        </div>

        <!-- بطاقة العنوان من الباك إند -->
        @if (calculationDetails()?.title) {
          <div class="mb-6 p-4 bg-gradient-to-r from-[#2c3e50]/10 to-[#d4af37]/10 border border-[#2c3e50]/20 rounded-lg">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[#2c3e50]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <h3 class="text-xl font-bold text-[#2c3e50]">وصف المسألة</h3>
            </div>
            <p class="mt-2 text-gray-700 text-lg">{{ calculationDetails()?.title }}</p>
          </div>
        }

        <!-- ملخص الحساب -->
        <!-- @if (calculationDetails(); as details) {
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h3 class="text-lg font-semibold text-[#1C352D] mb-2">ملخص الحساب</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @if (details.totalEstate !== undefined) {
              <div class="flex justify-between">
                <span class="text-gray-700 text-base">إجمالي التركة:</span>
                <span class="font-bold text-[#1C352D] text-lg">{{ details.totalEstate | number:'1.2-2' }}</span>
              </div>
            }
            @if (details.debts !== undefined && details.debts > 0) {
              <div class="flex justify-between">
                <span class="text-gray-700 text-base">الديون المستحقة:</span>
                <span class="font-bold text-red-600 text-lg">-{{ details.debts | number:'1.2-2' }}</span>
              </div>
            }
            @if (details.willAmount !== undefined && details.willAmount > 0) {
              <div class="flex justify-between">
                <span class="text-gray-700 text-base">الوصايا:</span>
                <span class="font-bold text-amber-600 text-lg">-{{ details.willAmount | number:'1.2-2' }}</span>
              </div>
            }
            @if (details.netEstate !== undefined) {
              <div class="flex justify-between border-t pt-2 mt-2">
                <span class="text-gray-700 font-bold text-lg">صافي التركة للتوزيع:</span>
                <span class="font-bold text-green-600 text-xl">{{ details.netEstate | number:'1.2-2' }}</span>
              </div>
            }
          </div>
        </div>
      } -->

        <!-- تحسينات الجدول -->
        <div class="rounded-lg border border-slate-200 shadow-sm mb-6">
        <div class="overflow-x-auto">
          <table class="w-full text-start table-auto">
            <thead class="bg-slate-100">
<tr>

  <th class="p-2 text-sm font-bold text-center w-[10%]">
    الوارث
  </th>

  <th class="p-2 text-sm font-bold text-center w-[15%]">
    النصيب
  </th>

  <th class="p-2 text-sm font-bold text-center w-[8%]">
    عدد الأفراد
  </th>

  <th class="p-2 text-sm font-bold text-center w-[10%]">
    نسبة الفرد
  </th>

  @if (hasEstateAmount()) {
  <th class="p-2 text-sm font-bold text-center w-[12%]">
    مبلغ الفرد
  </th>
  }

  <th class="p-2 text-sm font-bold text-center w-[50%]">
    سبب الاستحقاق
  </th>

</tr>
</thead>

            <tbody class="divide-y divide-slate-200 bg-white">
              @for (item of results; track item.heirType) {
                <tr class="even:bg-slate-50/70">
                  <td class="p-4 font-bold text-[#1C352D] text-lg text-center">{{ item.heirType }}</td>
                  <td class="p-4 font-medium font-mono text-center text-slate-800 text-lg">{{ item.nasib }}</td>
                  <td class="p-4 font-medium text-slate-800 text-lg text-center">{{ item.countMembers }}</td>
                  <td class="p-4 font-medium font-mono text-center text-slate-800 text-lg">{{ item.nisbtElfard }}</td>
                  @if (hasEstateAmount()) {
                  <td class="p-4 font-bold font-mono text-xl text-[#1C352D] text-center">
                    {{ item.individualAmount | number:'1.2-2' }}
                  </td>
                  }
                  <td class="p-4 text-base text-slate-600 text-start whitespace-normal break-words max-w-[400px] leading-relaxed">
                    {{ item.reason }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
          @if (calculationDetails()?.note) {
            <div class="p-4 bg-blue-50 border-t-2 border-blue-200">
              <div class="text-blue-800 text-base leading-relaxed">
                <span class="font-bold">ملاحظة:</span> {{ calculationDetails()?.note }}
              </div>
            </div>
          }
          </div>
        </div>

        <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4 relative">
          <button type="button" (click)="saveCalculation(false)" [disabled]="saveStatus() !== 'idle'"
            class="w-full sm:w-auto flex items-center justify-center gap-2 bg-[#2c3e50]/20 text-[#2c3e50] font-semibold py-3 px-6 rounded-full disabled:bg-green-100 disabled:text-green-700 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2c3e50] hover:bg-[#2c3e50]/30 hover:shadow-md transition-all duration-200 ease-in-out cursor-pointer">
            @if (saveStatus() === 'saved') {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd" />
            </svg>
            <span>تم الحفظ</span>
            } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
            </svg>
            <span>حفظ الحساب</span>
            }
          </button>

          <button type="button" (click)="saveCalculation(true)" [disabled]="saveStatus() !== 'idle'"
            class="w-full sm:w-auto flex items-center justify-center gap-2 bg-white text-[#AA5656] border border-[#AA5656]/50 font-semibold py-3 px-6 rounded-full disabled:bg-rose-100 disabled:text-rose-700 disabled:border-rose-200 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#AA5656] hover:bg-[#AA5656]/10 hover:border-[#AA5656]/80 hover:shadow-md transition-all duration-200 ease-in-out cursor-pointer">
            @if (saveStatus() === 'favorited') {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd" />
            </svg>
            <span>تم الإضافة للمفضلة</span>
            } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                clip-rule="evenodd" />
            </svg>
            <span>إضافة للمفضلة</span>
            }
          </button>
        </div>

        <div class="mt-8 border-t pt-4">
          <p class="text-center text-xl text-[#2c3e50]/80 bold">
            هذه النتائج تقريبية وقابلة للمراجعة من قبل متخصصين في الفقه الإسلامي طبقا للقانون المصري
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
